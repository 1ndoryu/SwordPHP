<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sword v2 - API Tester</title>
		<style>
			:root {
				--bg-color: #1a1a1a;
				--text-color: #e0e0e0;
				--primary-color: #007bff;
				--border-color: #444;
				--input-bg: #2a2a2a;
				--card-bg: #242424;
				--success-color: #28a745;
				--error-color: #dc3545;
				--warning-color: #ffc107;
			}
			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				background-color: #0b0b0b;
				color: var(--text-color);
				margin: 0;
				padding: 20px;
				font-size: 12px;
				display: flex;
				flex-direction: row;
				gap: 20px;
			}
			h1,
			h2,
			h3 {
				border-bottom: 2px solid var(--primary-color);
				padding-bottom: 10px;
			}
			h3 {
				margin-top: 0;
				color: var(--primary-color);
				border-bottom: none;
				padding-bottom: 0;
			}
			.main-container {
				display: flex;
				flex-direction: column;
				width: 50%;
				gap: 20px;
			}
			.card {
				background-color: var(--card-bg);
				border: 1px solid var(--border-color);
				border-radius: 8px;
				padding: 20px;
				display: flex;
				flex-direction: column;
				gap: 15px;
			}
			form {
				display: flex;
				flex-direction: column;
				gap: 10px;
			}
			input,
			textarea,
			select,
			button {
				background-color: var(--input-bg);
				color: var(--text-color);
				border: 1px solid var(--border-color);
				padding: 10px;
				border-radius: 4px;
				width: 100%;
				box-sizing: border-box;
			}
			textarea {
				resize: vertical;
				min-height: 80px;
			}
			button {
				background-color: var(--primary-color);
				color: white;
				border: none;
				cursor: pointer;
				font-weight: bold;
				transition: opacity 0.2s;
			}
			button:hover {
				opacity: 0.9;
			}
			button.danger {
				background-color: var(--error-color);
			}
			button.warning {
				background-color: var(--warning-color);
				color: #1a1a1a;
			}
			.response-area {
				width: 50%;
				display: flex;
				flex-direction: column;
			}
			#response {
				background-color: black;
				border: 1px solid var(--border-color);
				border-radius: 4px;
				padding: 15px;
				white-space: pre-wrap;
				word-wrap: break-word;
				flex-grow: 1;
				overflow-y: auto;
				font-family: 'Courier New', Courier, monospace;
			}
			.token-status {
				font-style: italic;
			}
			.token-status span {
				font-weight: bold;
			}
			.success {
				color: var(--success-color);
			}
			.error {
				color: var(--error-color);
			}
			hr {
				width: 100%;
				margin: 0;
				border: none;
				border-top: 1px solid var(--border-color);
			}
		</style>
	</head>
	<body>
		<div class="main-container">
			<h1>Sword v2 - API Tester</h1>

			<div class="card">
				<h3>Suite de Pruebas Automatizada</h3>
				<p>Ejecuta una serie de pruebas E2E que validan el flujo principal de la aplicación. Los resultados detallados aparecerán en la consola de respuesta.</p>
				<button id="run-all-tests" class="warning">Ejecutar Suite de Pruebas Completa</button>
			</div>

			<div class="card">
				<h3>Autenticación</h3>
				<div class="token-status">JWT Token: <span id="token-display">No obtenido</span></div>
				<form id="login-form">
					<input type="text" name="identifier" placeholder="Username o Email" required value="admin@test.com" />
					<input type="password" name="password" placeholder="Password" required value="password123" />
					<button type="submit">Login</button>
				</form>
			</div>

			<div class="card">
				<h3>Administración del Sistema (Público)</h3>
				<p>Acciones manuales. Usar con precaución.</p>
				<button id="install-db-btn" class="warning">Instalar Base de Datos</button>
				<button id="reset-db-btn" class="danger">Resetear Base de Datos</button>
			</div>
		</div>

		<div class="response-area">
			<h2>Respuesta de la API</h2>
			<pre id="response">Las respuestas de la API aparecerán aquí...</pre>
		</div>

		<script>
			const API_BASE_URL = window.location.origin;
			const responseEl = document.getElementById('response');
			const tokenDisplayEl = document.getElementById('token-display');

			let jwtToken = localStorage.getItem('jwt_token') || null;
			updateTokenDisplay();

			function updateTokenDisplay() {
				if (jwtToken) {
					tokenDisplayEl.textContent = 'Guardado en LocalStorage';
					tokenDisplayEl.className = 'success';
				} else {
					tokenDisplayEl.textContent = 'No obtenido';
					tokenDisplayEl.className = 'error';
				}
			}

			const log = (message, type = 'info') => {
				const colorMap = {
					info: '#e0e0e0',
					success: 'var(--success-color)',
					error: 'var(--error-color)',
					warning: '#f0ad4e',
					step: 'var(--primary-color)'
				};
				responseEl.innerHTML += `<span style="color:${colorMap[type]}">${message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>\n`;
				responseEl.scrollTop = responseEl.scrollHeight;
			};

			async function apiCall(endpoint, method = 'GET', body = null, needsAuth = true, isFile = false) {
				const headers = {};
				if (needsAuth) {
					if (!jwtToken) {
						log('Error: Token JWT no encontrado. Por favor, haz login primero.', 'error');
						return {ok: false, data: {message: 'Token no disponible'}, status: 401};
					}
					headers['Authorization'] = `Bearer ${jwtToken}`;
				}
				if (!isFile && body) {
					headers['Content-Type'] = 'application/json';
				}

				try {
					const config = {method, headers};
					if (body) {
						config.body = isFile ? body : JSON.stringify(body);
					}

					const res = await fetch(`${API_BASE_URL}${endpoint}`, config);
					const status = res.status;
					let data;

					if (status === 204) {
						data = {success: true, message: 'Operación exitosa (No Content)'};
					} else {
						data = await res.json().catch(() => ({success: false, message: 'No se pudo decodificar la respuesta JSON.'}));
					}
					return {ok: res.ok, data, status};
				} catch (error) {
					log(`Error de Red: ${error.message}`, 'error');
					return {ok: false, data: {message: error.message}, status: 0};
				}
			}

			// --- Event Listeners Manuales ---
			document.getElementById('login-form').addEventListener('submit', async e => {
				e.preventDefault();
				const body = Object.fromEntries(new FormData(e.target).entries());
				const {ok, data, status} = await apiCall('/auth/login', 'POST', body, false);
				responseEl.textContent = `Status: ${status}\n\n${JSON.stringify(data, null, 2)}`;
				if (ok && data.data && data.data.access_token) {
					jwtToken = data.data.access_token;
					localStorage.setItem('jwt_token', jwtToken);
					updateTokenDisplay();
				}
			});

			document.getElementById('install-db-btn').addEventListener('click', async () => {
				if (confirm('¿Estás seguro? Esto ejecutará db:install.')) {
					const {data, status} = await apiCall('/system/install', 'POST', null, false);
					responseEl.textContent = `Status: ${status}\n\n${JSON.stringify(data, null, 2)}`;
				}
			});

			document.getElementById('reset-db-btn').addEventListener('click', async () => {
				if (confirm('ADVERTENCIA: ¿Seguro que quieres borrar todas las tablas?')) {
					const {data, status} = await apiCall('/system/reset', 'POST', null, false);
					responseEl.textContent = `Status: ${status}\n\n${JSON.stringify(data, null, 2)}`;
				}
			});

			// --- Suite de Pruebas Automática ---
			document.getElementById('run-all-tests').addEventListener('click', runFullTestSuite);

			async function runFullTestSuite() {
				responseEl.innerHTML = '';
				log('===== INICIANDO SUITE DE PRUEBAS E2E =====', 'warning');

				const rand = Date.now();
				const adminCreds = {username: `admin_${rand}`, email: `admin_${rand}@test.com`, password: 'password123'};
				const userCreds = {username: `user_${rand}`, email: `user_${rand}@test.com`, password: 'password123'};
				let localAdminToken = null;
				let localUserToken = null;
				let contentId = null;
				let mediaId = null;

				async function testStep(name, endpoint, method, body, token, isFile = false, expectedStatus = 200) {
					log(`\n[PASO] ${name}`, 'step');
					
					const useAuth = !endpoint.startsWith('/system/');

					const headers = {};
					if (useAuth && token) headers['Authorization'] = `Bearer ${token}`;

					if (!isFile && body) headers['Content-Type'] = 'application/json';

					const config = {method, headers};
					if (body) config.body = isFile ? body : JSON.stringify(body);

					try {
						const res = await fetch(API_BASE_URL + endpoint, config);
						const status = res.status;
						const data = status === 204 ? {success: true, message: 'No Content'} : await res.json().catch(() => ({}));

						if (status === expectedStatus) {
							log(` [ÉXITO] ${status} - ${data.message || 'Operación completada.'}`, 'success');
							return data;
						} else {
							log(` [FALLO] Se esperaba status ${expectedStatus} pero se recibió ${status}.`, 'error');
							log(`  Respuesta: ${data.message || 'Sin mensaje.'}`, 'error');
							if(data.data && data.data.output) log(`    Salida: ${data.data.output}`, 'info');
							return null;
						}
					} catch (error) {
						log(` [ERROR DE RED] ${error.message}`, 'error');
						return null;
					}
				}
				
				log('\n--- FASE PREVIA: Limpieza del Entorno ---', 'warning');
				await testStep('Resetear Base de Datos', '/system/reset', 'POST', null, null, false, 200);
				await testStep('Instalar Base de Datos', '/system/install', 'POST', null, null, false, 200);

				log('\n--- FASE 1: Registro y Autenticación ---', 'warning');
				await testStep('Registrar usuario "admin"', '/auth/register', 'POST', adminCreds, null, false, 200);
				await testStep('Registrar usuario "user"', '/auth/register', 'POST', userCreds, null, false, 200);

				const adminLogin = await testStep('Login como "admin"', '/auth/login', 'POST', {identifier: adminCreds.email, password: adminCreds.password}, null, false, 200);
				if (adminLogin && adminLogin.data) localAdminToken = adminLogin.data.access_token;

				const userLogin = await testStep('Login como "user"', '/auth/login', 'POST', {identifier: userCreds.email, password: userCreds.password}, null, false, 200);
				if (userLogin && userLogin.data) localUserToken = userLogin.data.access_token;

				if (!localAdminToken || !localUserToken) {
					log('\n[ERROR CRÍTICO] No se pudieron obtener los tokens. Abortando pruebas.', 'error');
					return;
				}

				log('\n--- FASE 2: CRUD de Contenidos (Usuario) ---', 'warning');
				const createdContent = await testStep('Crear contenido', '/contents', 'POST', {status: 'published', content_data: {title: 'Post de Prueba Automático', body: 'Cuerpo del post.'}}, localUserToken, false, 201);

				if (createdContent && createdContent.data) {
					contentId = createdContent.data.id;
					await testStep('Ver contenido público', `/contents/${createdContent.data.slug}`, 'GET', null, null, false, 200);
					await testStep('Actualizar contenido', `/contents/${contentId}`, 'POST', {status: 'draft', content_data: {title: 'Post (Actualizado)'}}, localUserToken, false, 200);
				} else {
					log('[ADVERTENCIA] No se pudo crear contenido, saltando pruebas dependientes.', 'warning');
				}

				log('\n--- FASE 3: Pruebas de Media ---', 'warning');
				const formData = new FormData();
				formData.append('file', new File(['dummy content'], 'test.txt', {type: 'text/plain'}));
				const uploadedMedia = await testStep('Subir archivo', '/media', 'POST', formData, localUserToken, true, 201);
				if (uploadedMedia && uploadedMedia.data) mediaId = uploadedMedia.data.id;

				log('\n--- FASE 4: Pruebas de Listado (Admin) ---', 'warning');
				await testStep('Listar todos los contenidos (Admin)', '/admin/contents', 'GET', null, localAdminToken, false, 200);
				await testStep('Listar todos los archivos (Admin)', '/admin/media', 'GET', null, localAdminToken, false, 200);

                log('\n--- FASE 5: Pruebas del Sistema de Opciones ---', 'warning');
                const optionsPayload = { site_title: 'Sword v2 Test Site', maintenance_mode: false, posts_per_page: 12 };
                const updatedOptions = await testStep('Actualizar opciones (Admin)', '/admin/options', 'POST', optionsPayload, localAdminToken, false, 200);
                
                if (updatedOptions) {
                    const publicOptions = await testStep('Obtener opciones (Público)', '/options', 'GET', null, null, false, 200);
                    if (publicOptions && publicOptions.data.site_title !== 'Sword v2 Test Site') {
                        log(' [FALLO] La opción "site_title" no coincide con el valor actualizado.', 'error');
                    } else if (publicOptions) {
                        log('  [ÉXITO] Las opciones públicas coinciden con las actualizadas.', 'success');
                    }
                }

				log('\n--- FASE 6: Limpieza de Residuos ---', 'warning');
				if (mediaId) {
					await testStep('Eliminar archivo subido (Admin)', `/admin/media/${mediaId}`, 'DELETE', null, localAdminToken, false, 204);
				}
				if (contentId) {
					await testStep('Eliminar contenido creado (User)', `/contents/${contentId}`, 'DELETE', null, localUserToken, false, 204);
				}

				log('\n===== SUITE DE PRUEBAS FINALIZADA =====', 'warning');
			}
		</script>
	</body>
</html>